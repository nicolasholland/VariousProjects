A "short" history of docker problems
====================================

Working on a docker image for a client with multiple challenging requirements/dependencies, (eg
need to have protobuf, need to run on both ARM and AMD architecture, everyone involved in project
has a different OS, there may even be need to run tensorflow in the container at some point)
we starting making a list of all the weird troubles we ran into and what we tried to fix them.
This list is meant as a list for us to look things up in case we ever run into troubles like this,
or potentially making a blog post about "docker challenges" in the future.

I read a bit of this [devops blog](https://www.masterdevops.eu/), some
of dockers documentation and of course a lot of stackoverflow.

* Problem:

    "unknown flag --platform"

* Solution:

    Update docker

* Problem:

    only available in experimental features"

* Solution:

    etc/docker/daemon.json

    {
    "experimental": true
    }

* Error:

    ```
    docker: Error response from daemon: OCI runtime create failed: container_linux.go:345: starting container process caused "process_linux.go:430: container init caused \"write /proc/self/attr/keycreate: permission denied\"": unknown.
    ```

* Solution:

    ```
    $ sudo yum install http://mirror.centos.org/centos/7/extras/x86_64/Packages/container-selinux-2.107-1.el7_6.noarch.rpm
    ```

* Error:

    ```
    standard_init_linux.go:211: exec user process caused "exec format error"
    ```

* Solution:

    Caused by trying to build for arm7

* Error:

    TypeError: Descriptors cannot not be created directly.
    If this call came from a _pb2.py file, your generated code is out of date and must be regenerated with protoc >= 3.19.0.

* Solution:

    docker container had python 3.9 & protobuf 4.21.4

	```
    >>> import google.protobuf
    >>> google.protobuf.__version__
    '4.21.4'
	```

    But host machine had python 3.6 and protobuf 3.19.4

    Side node: This speaks to a new level of docker problems!
    Code that was generated by protobuf before building the image
    which is then to be used inside the container with a different
    protobuf version?!!!

    Ended up changing the requirements.txt:

	```
    protobuf==3.19.4
	```

* Error:

    Docker container was able to start and proto modules were
    able to be imported, but mqtt client wasn't working anymore:

	```
    OSError: [Errno 99] Cannot assign requested address
	```

* Solution:

    Networkmode host:

    Add "--net=host" to the docker run command


* Intermediate situation:

    The container was finally able to be up & running, connecting
    to the message broker and answering requests with the appropriate
    responses.

	```
    $ docker image inspect <name> --format '{{ .Os }}/{{ .Architecture }}'
    linux/amd64
	```

    Building for arm (using --platform linux/arm/v7) has to be done by
    repulling the base image (FROM python:3.9-slim) and will cause this:

	```
    $ docker image inspect <name> --format '{{ .Os }}/{{ .Architecture }}'
    linux/arm
	```

    but when testing the image we get

	```
    standard_init_linux.go:211: exec user process caused "exec format error"
	```

* Use buildx:

	```
    $ wget https://github.com/docker/buildx/releases/download/v0.2.0/buildx-v0.2.0.linux-amd64
	```

* Error:

	Docker version simply too old, but how to remove it?
	All the docker documentation did not help, none of that "sudo dnf remove ..."
	was able to remove my docker version.

* Solution:

	```
	$ echo $PATH
	```

	then going through all the folders looking for the stupid docker binary and removing them!

* Next step:

	download latest docker-desktop version for fedora and installing
	
	```
	$ sudo dnf install ./docker-desktio-4.11.0-x86_64.rpm
	```

* Error:

	Even though the docker documentation claims that the .rpm installation will put
	some stuff into /usr/bin/docker, I find there is nothing there!

* Solution:

	There was still a soft link in /usr/local/bin/com.docker.cli
	that one belonged to root and was not removed by our previous attempts.
	Removing it helped only in so far that we then had to reinstall (after removing of course)
	the .rpm file again.

* Error:

	The previous solution did not actually work because that malicious softlink
	is created by the .rpm installation! But it does not link to anything!


Final take-away: we believe our fedora version is too old (28)
-> Need to install a newer OS to run newer docker versions.

Customers docker version is 20.10.12, so I can see why they did not have our issues.

After installing a new OS (ubuntu) and Docker (way easier than on fedora) we had to install buildx 
(and this side helped us [link](https://community.arm.com/arm-community-blogs/b/tools-software-ides-blog/posts/getting-started-with-docker-for-arm-on-linux),
it is way better then the often useless docker documentation )

	```
	$ wget https://github.com/docker/buildx/releases/download/v0.8.2/buildx-v0.8.2.linux-amd64
	$ mv ~/Downloads/buildx-v0.8.2.linux-amd64 ~/.docker/cli-plugins/docker-buildx
	```

* Error:

	```
    error: failed to solve: executor failed running
	```

    We found this error was not uncommen when building for arm7.


* Additional issues:

	After switching from fedora to ubuntu we observed a completly different docker
	image no longer working, crashing with "illegal instruction (core dumped)"
	After investigating the issue we found it was caused by tensorflow being part
	of this docker image, which for some reason does not work on the new ubuntu os
	(it did work under the old fedora os, we have no idea how that is caused)

	Btw how to bring tensorflow via a docker image to an arm processor? That is a question for future us.

Another side note:

	It is possible to have multiple Dockerfiles in the same repo!
	(found this on stackoverflow, very useful)
	
	```
	$ docker build -f Dockerfile.db .
	$ docker build -f Dockerfile.web .
	```
